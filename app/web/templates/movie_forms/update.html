{% extends "base.html" %}

{% block content %}

<h2 class="text-center">Update Movie</h2>
<form id="updateForm">
    <div>
        <label for="title">Название</label>
        <input type="text" id="title" class="form-control">
    </div>
    <div>
        <label for="description">Описание</label>
        <textarea id="description" class="form-control" rows="3"></textarea>
    </div>

    <div>
        <label for="thumbnail">Фото</label>
        <input type="file" id="thumbnail" class="form-control" accept="image/*">
    </div>

    <div>
        <label>
            <input type="checkbox" id="isPublic"> Сделать общедоступным?
        </label>
    </div>
    <br>
    <button type="submit" class="btn btn-primary">Обновить</button>
    <a href="/about" class="btn btn-danger">Отменить</a>
</form>
        
{% if current_user.role != "ADMIN" %}
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            window.location.href = "/"
        });
    </script>
{% endif %}

<script>
    // ✅ Get movie ID from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const movieId = urlParams.get("id");

    if (!movieId) {
        alert("Error: Movie ID is missing.");
        window.location.href = "/about";
    }

    async function fetchMovieDetails() {
        const token = getAccessTokenFromCookie();
        if (!token) {
            alert("Authentication required.");
            return;
        }

        try {
            const response = await fetch(`/api/movies/${movieId}`, {
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (!response.ok) {
                throw new Error(await response.text());
            }

            const movie = await response.json();
            document.getElementById("title").value = movie.title;
            document.getElementById("description").value = movie.description;
            document.getElementById("isPublic").checked = movie.is_public;
        } catch (error) {
            alert("Error loading movie: " + error.message);
        }
    }

    async function updateMovie(event) {
        event.preventDefault();
    
        const token = getAccessTokenFromCookie();
        if (!token) {
            alert("Authentication required.");
            return;
        }
            
        // ✅ Only send fields that are modified (ignore empty values)
        let formData = new FormData();

        const title = document.getElementById("title").value.trim();
        const description = document.getElementById("description").value.trim();
        const isPublic = document.getElementById("isPublic").checked;

        if (title) formData.append("title", title);
        if (description) formData.append("description", description);
        formData.append("is_public", isPublic);  // Always include `is_public`

        // ✅ Handle thumbnail file
        const thumbnailInput = document.getElementById("thumbnail");
        if (thumbnailInput.files.length > 0) {
            formData.append("thumbnail_path", thumbnailInput.files[0]);  // ✅ Correctly append file
        }

        try {
            const response = await fetch(`/api/movies/${movieId}`, {
                method: "PUT",
                headers: { "Authorization": `Bearer ${token}` },
                body: formData
            });
    
            const result = await response.json();
    
            if (!response.ok) {
                throw new Error(result.detail);
            }
    
            alert("Movie updated successfully!");
            window.location.href = "/about";
        } catch (error) {
            alert("Error updating movie: " + error.message);
        }
    }
    

    document.addEventListener("DOMContentLoaded", fetchMovieDetails);
    document.getElementById("updateForm").addEventListener("submit", updateMovie);
</script>

{% endblock %}