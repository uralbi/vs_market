{% extends "base.html" %}

{% block content %}

<div class="container">

<h1> Добро пожаловать {{current_user.username}} ! </h1>
<h5>{{current_user.email}} : <small class="text text-secondary">{{current_user.role.value}}</small></h5>

    <div class="card shadow-sm border-0 rounded-3 w-50 mb-4">
        <div class="profile_note"></div>
        <div class="card-body p-2 profile_card">
            <h5 class="mb-1 text-primary my_profile_title">Мой профиль <small>(Видимый для всех)</small></h5>
            <div class="profile_card_body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center p-1">
                        <span class="fw-semibold">Название:</span>
                        <span id="entityName" class="text-muted">Loading...</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center p-1">
                        <span class="fw-semibold">Телефон:</span>
                        <span id="entityPhone" class="text-muted">Loading...</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center p-1">
                        <span class="fw-semibold">Адрес:</span>
                        <span id="entityAddress" class="text-muted">Loading...</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center p-1">
                        <span class="fw-semibold">Востап:</span>
                        <span id="entityWhatsApp" class="text-muted">Loading...</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>

<hr>

<h5>Сообщения</h5>
    <ul class="list-group" id="chatRoomsList"></ul>

<hr>

{% if current_user.role in ["ADMIN", "CREATOR"] %}

    <h5>My Movies</h5>    
    {% include "movie_forms/mylist.html" %}

{% endif %}


<h5>Мои фильмы</h5>
{% include "movie_forms/order_list.html" %}
<hr>

<h5>Мои объявления</h5>
{% include "product_forms/mylist.html" %}

<hr>

<h5>Мои сохраненные объявления</h5>
{% include "product_forms/myfavs.html" %}



<script>
    let EntityID;

    async function loadUserInfo(user_id) {
        try {
            let response = await fetch(`/api/ent/${user_id}`, { method: "GET" });
    
            if (!response.ok) {
                let errorData = await response.json();
                console.log("No entity for this user");
                document.getElementsByClassName("profile_card_body")[0].style.display = "none";
                document.getElementsByClassName("my_profile_title")[0].innerHTML = `<a href="#createEntityForm"> Создать профиль видимый для всех</a> `
                profile_card

                return;
            } else {

            let entity = await response.json();
    
            document.getElementById("entityName").innerText = entity.entity_name;
            document.getElementById("entityPhone").innerText = entity.entity_phone;
            document.getElementById("entityAddress").innerText = entity.entity_address;
            document.getElementById("entityWhatsApp").innerText = entity.entity_whatsapp;
    
            EntityID = entity.id;
            }
    
        } catch (error) {
            console.error("Fetch error:", error);
            document.getElementById("userInfo").innerText = "Network error.";
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        loadUserInfo({{ current_user.id }});
    });
    

    document.addEventListener("DOMContentLoaded", async function() {
        let token = getAccessTokenFromCookie()
        loadChatRooms(token)
    });
    
        
    async function loadChatRooms(token) {
        try {
            const response = await fetch(`/chat/rooms/`, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                }
            });
    
            if (!response.ok) {
                throw new Error("Failed to fetch chat rooms");
            }
    
            const chatRooms = await response.json();
            const chatRoomsList = document.getElementById("chatRoomsList");
    
            // Clear previous chat list to prevent duplication
            chatRoomsList.innerHTML = "";
    
            if (chatRooms.length === 0) {
                chatRoomsList.innerHTML = "<li class='list-group-item'>No chat rooms found</li>";
                return;
            }
    
            chatRooms.forEach(room => {
                const listItem = document.createElement("li");
                listItem.classList.add("my_list_group");
                listItem.innerHTML = `
                    <a href="/messages?room_id=${room.chat_room_id}" class="text-decoration-none">
                    
                        От ${room.other_username}  <small class="text text-secondary">(${room.subject})</small>
                        <span class="my_badge_unread"> 
                        ${room.has_unread_messages ? `<i class="bi bi-envelope-arrow-down text-danger"></i>`: `<i class="bi bi-check2-circle text-success"></i>`} </span>
                    </a>
                    <button class="btn btn-outline-danger btn-sm float-end" onclick="deleteChatRoom(${room.chat_room_id})">
                        <i class="bi bi-trash3"></i> 
                </button>
                `;

                chatRoomsList.appendChild(listItem);
            });
        } catch (error) {
            console.error("Error loading chat rooms:", error);
        }
    }
    
    async function deleteChatRoom(chatRoomId) {
        if (!confirm("Are you sure you want to delete this chat room?")) return;
        let token = getAccessTokenFromCookie();
        try {
            const response = await fetch(`/chat/rooms/${chatRoomId}`, {
                method: "DELETE",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                }
            });
    
            if (!response.ok) {
                console.log(`Error: ${response.status}`);
            } else {
                showMessage("Чат был удален!", "success")
                loadChatRooms(token); // Reload chat rooms after deletion
            }
            

        } catch (error) {
            console.error("Failed to delete chat room:", error);
            alert("Error deleting chat room. Please try again.");
        }
    }

</script>

<br>


</div>
{% endblock %}