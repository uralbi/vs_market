
<h2>My Products</h2>
<div id="productList"></div>


<script>
async function fetchMyProducts() {
    let token = document.cookie.split('; ').find(row => row.startsWith('access_token='));
    if (!token) {
        document.getElementById("productList").innerHTML = "<p>You are not logged in.</p>";
        return;
    }
    token = token.split("=")[1]; // Extract token value

    let response = await fetch("/api/products/mylist", {
        method: "GET",
        headers: { "Authorization": `Bearer ${token}` }
    });

    if (!response.ok) {
        document.getElementById("productList").innerHTML = "<p>Failed to load products.</p>";
        return;
    }

    let products = await response.json();
    displayProducts(products);
}

function displayProducts(products) {
    let productListDiv = document.getElementById("productList");
    productListDiv.innerHTML = ""; // Clear previous items

    if (products.length === 0) {
        productListDiv.innerHTML = "<p>No products found.</p>";
        return;
    }

    products.forEach(product => {
        let productDiv = document.createElement("div");
        productDiv.classList.add("product-card");
        productDiv.classList.add("card");
        
        let productName = product.name;
        let productDescription = product.description;
        productName += `<span class="card-text"> - ${productDescription} </span>`;
        productDiv.innerHTML = `
                <div class="card-img-top">
                    <img src="/${product.image_urls[0]}" alt="Product Image" class="card-img-inside">
                </div>
                
                <div class="card-body">
                    <h5 class="card-title">${productName} </h5>
                    <small class="is_active text-${product.activated? "success": "danger"}"> ${product.activated? "Активный &#9889;": "Не активный &#10060;"} </small>
                    <p class="card-price">
                        ${displayPrice(product.price, product.is_dollar)}
                    </p>
                    
                    <button class="btn btn-sm btn-outline-danger my_item_del_btn" onclick="deleteProduct(${product.id})"> &#128465;	</button>
                    <a class="btn btn-sm btn-outline-success my_item_update_btn" href="/update-product/${product.id}" > &#128395;</a>
                    
                </div>
                `;
        productListDiv.appendChild(productDiv);
    });
}

function displayPrice(price, isDollar) {
    const exchangeRate = 87.8;
    
    function formatLargeNumbers(value, isUSD = false) {
        if (value >= 10_000_000_000) return (value / 1_000_000_000).toFixed(1) + (isUSD ? " млрд" : " млрд");
        if (value >= 10_000_000) return (value / 1_000_000).toFixed(1) + (isUSD ? " млн" : " млн");
        if (value >= 100_000) return (value / 1_000).toFixed(1) + (isUSD ? " тыс" : " тыс");
        if (value >= 10_000) return (value / 1_000).toFixed(1) + (isUSD ? " тыс" : " тыс");
        return value.toFixed(0);
    }

    if (isDollar) {
        let som = price * exchangeRate;
        return `$${formatLargeNumbers(price, true)} <br> <small> ${formatLargeNumbers(som, false)} с.</small>`;
    } else {
        let usd = price / exchangeRate;
        return `${formatLargeNumbers(price, false)} с.<br><small> $${formatLargeNumbers(usd, true)} </small>`;
    }
}

async function deleteProduct(productId) {
    let token = document.cookie.split('; ').find(row => row.startsWith('access_token=')).split("=")[1];

    let response = await fetch(`/api/products/delete/${productId}`, {
        method: "DELETE",
        headers: { "Authorization": `Bearer ${token}` }
    });

    if (response.ok) {
        fetchMyProducts(); // Reload product list after deletion
    } else {
        alert("Failed to delete product.");
    }
}


document.addEventListener("DOMContentLoaded", fetchMyProducts);
</script>