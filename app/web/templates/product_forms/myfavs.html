<h2>My Favorite Products</h2>
<ul id="favorite-products"></ul>

<script>
    async function fetchFavoriteProducts() {
        let token = document.cookie.split('; ').find(row => row.startsWith('access_token='));
        if (!token) {
            document.getElementById("favorite-products").innerHTML = "<li>You are not logged in.</li>";
            return;
        }

        token = token.split("=")[1];

        let response = await fetch("/favs", {
            method: "GET",
            headers: { "Authorization": `Bearer ${token}` }
        });

        if (response.ok) {
            let products = await response.json();
            let productList = document.getElementById("favorite-products");
            productList.innerHTML = ""; // Clear previous list

            if (products.length === 0) {
                productList.innerHTML = "<li>No favorite products yet.</li>";
                return;
            }

            products.forEach(product => {

                let productItem = document.createElement("div");
                productItem.classList.add("fav_card");

                let productName = product.name;
                let productDescription = product.description;
                productName += `<span class="card-text"> - ${productDescription} </span>`;

                productItem.innerHTML = `

                    <div class="card">
                        <div class="row g-0">
                            <div class="col-md-4">
                                <img src="${product.image_urls[0] || 'static/default.jpg'}" class="img-fluid rounded-start" alt="...">
                            </div>
                            <div class="col-md-8">
                                <div class="card-body">
                                    <a href="/product/${product.id}"><h5 class="card-title">${productName}</h5></a>
                                    <p class="card-price">
                                        ${displayPrice(product.price, product.is_dollar)}
                                    </p>
                                    <button class="btn btn-sm btn-outline-danger ms-1 " onclick="removeFromFavorites(${product.id})">
                                    <i class="bi bi-x-lg"></i> </button>
                                </div>
                            </div>
                        </div>
                    </div>                
                `;
                productList.appendChild(productItem);
            });
        } else {
            document.getElementById("favorite-products").innerHTML = "<li>Failed to load favorites.</li>";
        }
    }

    async function removeFromFavorites(productId) {
        let token = document.cookie.split('; ').find(row => row.startsWith('access_token=')).split("=")[1];

        let response = await fetch(`/favs/${productId}`, {
            method: "DELETE",
            headers: { "Authorization": `Bearer ${token}` }
        });

        if (response.ok) {
            showMessage("Объявление удалено из Избранных!", "success");
            fetchFavoriteProducts(); // Refresh the list
        } else {
            let error = await response.json();
            console.log(error.detail);
            showMessage("Ошибка при удалении!", "warning");
        }
    }

    // Fetch favorites when the page loads
    fetchFavoriteProducts();
</script>