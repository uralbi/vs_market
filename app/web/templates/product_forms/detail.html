{% extends "base.html" %}

{% block content %}


<div class="row">
    <!-- Product Image -->
    <div class="col-md-6">
        <div id="productImageContainer" class="text-center">
            <img id="productImage" src="" class="img-fluid rounded shadow" alt="Product Image">
        </div>
    </div>

    <!-- Product Details -->
    <div class="col-md-6">
        <div class="product_info_card">
            <h2 id="productName" class="product_name"></h2>

            <div id="is_activated_product" class="text-danger badge d-flex my-4 fs-5 p-0"></div>

            <p id="productCategory" class="product_category"></p>
            <p id="productPrice" class="product_price"></p>
            <p id="productDescription" class="product_description text-muted"></p>

            <div class="prodcut_ent_Name" id="entityName"></div>
            <div class="prodcut_ent_Address" id="entityAddress"></div>
            <div class="prodcut_ent_Phone" id="entityPhone"></div>
            <div class="prodcut_ent_WhatsApp" id="entityWhatsApp"></div>

            <div class="mt-3"> 
                <a href="#" id="chatSeller" class="btn btn-sm btn-outline-success chat_link_btn" data-receiver-id data-product-id> <i class="bi bi-chat-left-text"></i></a>
                <button id="pin_{{product_id}}" class="btn btn-sm btn-outline-secondary" onclick="addToFavorites({{product_id}})"><i class="bi bi-paperclip"></i></button>
            </div>
        </div>
    </div>
</div>

<script>

    async function loadProductDetails() {
        const productId = {{ product_id }}; // Ensure product_id is passed from template
    
        if (!productId) {
            alert("Invalid product ID");
            return;
        }
    
        try {
            let token = getAccessTokenFromCookie();
            const response = await fetch(`/api/products/${productId}`, {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    }
                });


            if (!response.ok ) {
                let error = await response.json()
                if (document.referrer) {
                    console.log('error', error)
                    window.location.href = document.referrer; // Redirect to the referring page
                } else {
                    console.log('error', error)
                    window.history.back(); // If no referrer, use history back
                }
                throw new Error("Product is not available yet"); 
            }
    
            const product = await response.json();

            // Populate product details
            document.getElementById("productName").textContent = product.name;
            document.getElementById("productCategory").textContent = product.category;
            document.getElementById("productPrice").innerHTML = displayPrice_org(product.price, product.is_dollar);
            document.getElementById("productDescription").innerHTML = product.description;
            
            if (!product.activated) {
                let elem = document.getElementById("is_activated_product").textContent = "NOT ACTIVATED"
            }
            
            // Display all product images in Bootstrap Carousel
            const imageContainer = document.getElementById("productImageContainer");
            if (product.image_urls.length > 0) {
                imageContainer.innerHTML = createImageCard(product.image_urls);
            } else {
                imageContainer.innerHTML = `<img src="/static/default-product.jpg" 
                class="img-fluid rounded shadow" alt="Product Image">`;
            }
    
            // Update chat link
            document.getElementById("chatSeller").dataset.receiverId = product.owner_id;
            document.getElementById("chatSeller").dataset.productId = product.id;

            if (product.owner_id == "{{current_user.id}}") {
                document.getElementById("chatSeller").classList.add('d-none')
            }
            loadEntityInfo(product.owner_id)

        } catch (error) {
            console.error("Error loading product:", error);
            alert(error);
        }
    }
    
    function createImageCard(imageUrls) {
        if (!imageUrls || imageUrls.length === 0) return "";
    
        let bigImageUrl = imageUrls[0]; // First image is the main image
        let thumbnails = imageUrls.map((url, index) => 
            `<img src="/${url}" class="thumbnail ${index === 0 ? '' : ''}" onclick="swapImage('/${url}')">`
        ).join("");
    
        return `
            <div class="item_detail_container">
                <div class="thumbnail-container row-1">
                    ${thumbnails}
                </div>
                <div class="big-image-container">
                    <img id="bigImage" src="/${bigImageUrl}" class="big-image">
                </div>
            </div>
    `;
    }
    
    function swapImage(newImageUrl) {
        document.getElementById("bigImage").src = newImageUrl;
    }

    
    // Function to Create Bootstrap Carousel for Images
    function createImageCarousel(images) {
        let indicators = "";
        let slides = "";
    
        images.forEach((imgUrl, index) => {
            const activeClass = index === 0 ? "active" : "";
            indicators += `<button type="button" data-bs-target="#productCarousel" data-bs-slide-to="${index}" class="${activeClass}" aria-label="Slide ${index + 1}"></button>`;
            slides += `
                <div class="carousel-item ${activeClass}">
                    <img src="/${imgUrl}" class="d-block w-100 rounded" alt="Product Image">
                </div>`;
        });
    
            return `
                <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-indicators">${indicators}</div>
                    <div class="carousel-inner">${slides}</div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>`;
        }
    
    // Load product details when page loads
    document.addEventListener("DOMContentLoaded", loadProductDetails);
    
    async function loadEntityInfo(user_id) {
    
        let response = await fetch(`/api/ent/${user_id}`, {
            method: "GET",
             }
        );
    
        if (response.ok) {
            let entity = await response.json();

            document.getElementById("entityName").innerHTML =    `Продавец: ${entity.entity_name}`;
            document.getElementById("entityPhone").innerHTML =   `Тел.    : ${entity.entity_phone}`;
            document.getElementById("entityAddress").innerHTML = `Адрес   : ${entity.entity_address}`;
            document.getElementById("entityWhatsApp").innerHTML = `Востап : ${entity.entity_whatsapp}`;
        } else {
            let errorData = await response.json();
            console.log("Error Response:", errorData);
            document.getElementById("userInfo").innerText = "Error loading user data.";
        }
    }

    document.querySelectorAll(".chat_link_btn").forEach(button => {
        button.addEventListener("click", async function () {
            try{ await authenticatedRequest('me') }
            catch(error){
                alert("Войдите чтоб написать продавцу.")
                return
            }
            const receiverId = this.getAttribute("data-receiver-id");
            const productId = this.getAttribute("data-product-id");
            window.location.href = `/messages/users?user_id={{current_user.id}}&receiver_id=${receiverId}&product_id=${productId}`;
        });
    });

</script>


{% endblock %}