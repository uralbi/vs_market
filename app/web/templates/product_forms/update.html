
{% extends "base.html" %}

{% block content %}

<form id="updateProductForm">
    <input type="hidden" id="product_id" value="">

    <label class="form-label">Название</label>
    <input class="form-control" type="text" id="update_name" placeholder="Название объявления">


    <label class="form-label" for="editor">Описание</label>
    <div id="editor"></div> 
    <input type="hidden" name="description" id="update_description">


    <label class="form-label">Price:</label>
    <input class="form-control" type="number" id="update_price" step="0.01">

    <div class="form-check mt-2">
        <input class="form-check-input" type="checkbox" id="update_is_dollar" name="is_dollar">
        <label class="form-check-label" for="is_dollar">
            В Долларах?
        </label>
    </div>

    <label class="form-label">Категории</label>
    <input class="form-control" type="text" id="update_category">

    <label class="form-label">Текущие фотографии</label>
    <div class="form-control" id="curr_images">
    </div>

    <div class="form-check mt-2">
        <input class="form-check-input" type="checkbox" id="keep_existing_images" name="keep_existing_images" checked>
        <label class="form-check-label" for="keep_existing_images">
            Сохранить текущие фотографии?
        </label>
    </div>

    <label class="form-label"> Загрузить фотографии</label>
    <input class="form-control" type="file" id="update_images" multiple>

    <div class="form-check mt-4 fw-bold p-0">
        <label class="form-label" for="update_activated"> Активировать? </label>
        <input class="form-input" type="checkbox" id="update_activated" name="update_activated" checked>
        
    </div>

    <button class="mt-2 btn btn-sm btn-outline-success" type="submit">Обновить объявления</button>

</form>

<script>    

    function getAccessTokenFromCookie() {
        const cookies = document.cookie.split("; ");
        for (let cookie of cookies) {
            const [name, value] = cookie.split("=");
            if (name === "access_token") return value;
        }
        return null;
    }

    async function loadProduct(productId) {

        let token = getAccessTokenFromCookie();

        let response = await fetch(`/api/products/my/${productId}`, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type":"application/json",
            }
        });

        if (!response.ok) {
            alert("Failed to load product");
            return;
        }

        let product = await response.json();
        
        // ✅ Populate form fields
        document.getElementById("product_id").value = productId;
        document.getElementById("update_name").value = product.name;
        quill.root.innerHTML = product.description;
        document.getElementById("update_price").value = product.price;
        document.getElementById("update_category").value = product.category;
        document.getElementById("update_is_dollar").checked = product.is_dollar;
        document.getElementById("update_activated").checked = product.activated;
        
        // ✅ Populate existing images
        let imageContainer = document.getElementById("curr_images");
        imageContainer.innerHTML = "";
        product.image_urls.forEach((imageUrl) => {
            let img = document.createElement("img");
            img.src = `/${imageUrl}`;
            img.width = 100;
            imageContainer.appendChild(img);
        });
    }

    loadProduct({{product_id}})


    document.getElementById("updateProductForm").addEventListener("submit", async function (event) {
        event.preventDefault();
    
        let productId = document.getElementById("product_id").value;
        let formData = new FormData();
    
        let token = getAccessTokenFromCookie();
        
        if (!token) {
                alert('Not Authorized')
                return
            }

        // Append only fields that have values
        let name = document.getElementById("update_name").value.trim();
        let description = quill.root.innerHTML;
        let price = document.getElementById("update_price").value.trim();
        let category = document.getElementById("update_category").value.trim();
        let images = document.getElementById("update_images").files;
        let is_dollar = document.getElementById("update_is_dollar").checked
        let activated = document.getElementById("update_activated").checked
        let keepExistingImages = document.getElementById("keep_existing_images").checked;

        
        formData.append("activated", activated.toString());
        formData.append("is_dollar", is_dollar.toString());
        formData.append("keep_existing_images", keepExistingImages.toString());
        if (name) formData.append("name", name);
        if (description) formData.append("description", description);
        if (price) formData.append("price", price);
        if (category) formData.append("category", category);
    
        // Add selected images
        for (let img of images) {
            formData.append("images", img);
        }

        let response = await fetch(`/api/products/update/${productId}`, {
            method: "PUT",
            headers: { "Authorization": `Bearer ${token}` },
            body: formData
        });
    
        if (response.ok) {
            window.location.href = "/about";
        } else {
            let error = await response.json();
            alert(error.detail);
        }
    });
    
</script>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<script>
    var quill = new Quill('#editor', {
        theme: 'snow',
        placeholder: "Enter product description...",
        modules: {
            toolbar: [
                [{ 'header': [1, 2, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'align': [] }],
                ['link', 'image'],
                ['clean']
            ]
        }
    });

</script>

{% endblock %}