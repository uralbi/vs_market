<form id="updateProductForm">
    <input type="hidden" id="product_id" value="">

    <div class="form-check mt-2">
        <input class="form-check-input" type="checkbox" id="update_activated" name="update_activated">
        <label class="form-check-label" for="update_activated">
            Активировать?
        </label>
    </div>

    <label class="form-label">Name:</label>
    <input class="form-control" type="text" id="update_name" placeholder="Product Name">

    <label class="form-label">Description:</label>
    <textarea class="form-control" id="update_description" placeholder="Description"></textarea>

    <label class="form-label">Price:</label>
    <input class="form-control" type="number" id="update_price" step="0.01">

    <div class="form-check mt-2">
        <input class="form-check-input" type="checkbox" id="update_is_dollar" name="is_dollar">
        <label class="form-check-label" for="is_dollar">
            В Долларах?
        </label>
    </div>

    <label class="form-label">Category:</label>
    <input class="form-control" type="text" id="update_category">

    <label class="form-label">Current Images:</label>
    <div class="form-control" id="curr_images">
    </div>

    <div class="form-check mt-2">
        <input class="form-check-input" type="checkbox" id="keep_existing_images" name="keep_existing_images" checked>
        <label class="form-check-label" for="keep_existing_images">
            Keep Existing Images?
        </label>
    </div>

    
    <label class="form-label">Upload Images (Optional):</label>
    <input class="form-control" type="file" id="update_images" multiple>

    <button class="mt-2 btn btn-sm btn-outline-success" type="submit">Update Product</button>

</form>

<script>    

    function getAccessTokenFromCookie() {
        const cookies = document.cookie.split("; ");
        for (let cookie of cookies) {
            const [name, value] = cookie.split("=");
            if (name === "access_token") return value;
        }
        return null;
    }

    async function loadProduct(productId) {

        let token = getAccessTokenFromCookie();

        let response = await fetch(`/api/products/my/${productId}`, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type":"application/json",
            }
        });

        if (!response.ok) {
            alert("Failed to load product");
            return;
        }

        let product = await response.json();
        
        console.log(product)

        // ✅ Populate form fields
        document.getElementById("product_id").value = productId;
        document.getElementById("update_name").value = product.name;
        document.getElementById("update_description").value = product.description;
        document.getElementById("update_price").value = product.price;
        document.getElementById("update_category").value = product.category;
        document.getElementById("update_is_dollar").checked = product.is_dollar;
        document.getElementById("update_activated").checked = product.activated;
        
        // ✅ Populate existing images
        let imageContainer = document.getElementById("curr_images");
        imageContainer.innerHTML = "";
        product.image_urls.forEach((imageUrl) => {
            let img = document.createElement("img");
            img.src = `/${imageUrl}`;
            img.width = 100;
            imageContainer.appendChild(img);
        });
    }

    loadProduct({{product_id}})


    document.getElementById("updateProductForm").addEventListener("submit", async function (event) {
        event.preventDefault();
    
        let productId = document.getElementById("product_id").value;
        let formData = new FormData();
    
        let token = getAccessTokenFromCookie();
        
        if (!token) {
                alert('Not Authorized')
                return
            }

        // Append only fields that have values
        let name = document.getElementById("update_name").value.trim();
        let description = document.getElementById("update_description").value.trim();
        let price = document.getElementById("update_price").value.trim();
        let category = document.getElementById("update_category").value.trim();
        let images = document.getElementById("update_images").files;
        let is_dollar = document.getElementById("update_is_dollar").checked
        let activated = document.getElementById("update_activated").checked
        let keepExistingImages = document.getElementById("keep_existing_images").checked;

        
        formData.append("activated", activated.toString());
        formData.append("is_dollar", is_dollar.toString());
        formData.append("keep_existing_images", keepExistingImages.toString());
        if (name) formData.append("name", name);
        if (description) formData.append("description", description);
        if (price) formData.append("price", price);
        if (category) formData.append("category", category);
    
        // Add selected images
        for (let img of images) {
            formData.append("images", img);
        }

        let response = await fetch(`/api/products/update/${productId}`, {
            method: "PUT",
            headers: { "Authorization": `Bearer ${token}` },
            body: formData
        });
    
        if (response.ok) {
            window.location.href = "/about";
        } else {
            let error = await response.json();
            alert(error.detail);
        }
    });
    
</script>
