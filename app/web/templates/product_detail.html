{% extends "base.html" %}

{% block content %}


<div class="row">
    <!-- Product Image -->
    <div class="col-md-6">
        <div id="productImageContainer" class="text-center">
            <img id="productImage" src="" class="img-fluid rounded shadow" alt="Product Image">
        </div>
    </div>

    <!-- Product Details -->
    <div class="col-md-6">
        <h2 id="productName" class="product_name"></h2>
        <p id="productCategory" class="product_category"></p>
        <p id="productPrice" class="product_price"></p>
        <p id="productDescription" class="product_description text-muted"></p>

        <div class="prodcut_ent_Name" id="entityName"></div>
        <div class="prodcut_ent_Address" id="entityAddress"></div>
        <div class="prodcut_ent_Phone" id="entityPhone"></div>
        <div class="prodcut_ent_WhatsApp" id="entityWhatsApp"></div>

        <div class="mt-3">
            <a href="#" id="chatSeller" class="btn btn-sm btn-outline-primary chat_link_btn" data-receiver-id=>üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ</a>
            <button class="btn btn-sm btn-outline-success" onclick="addToFavorites({{product_id}})">‚≠ê –î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
    </div>
</div>

<script>

    async function loadProductDetails() {
        const productId = {{ product_id }}; // Ensure product_id is passed from template
    
        if (!productId) {
            alert("Invalid product ID");
            return;
        }
    
        try {
            const response = await fetch(`/api/products/${productId}`);
            if (!response.ok) throw new Error("Product not found");
    
            const product = await response.json();
    
            // Populate product details
            document.getElementById("productName").textContent = product.name;
            document.getElementById("productCategory").textContent = product.category;
            document.getElementById("productPrice").innerHTML = displayPrice_org(product.price, product.is_dollar);
            document.getElementById("productDescription").textContent = product.description;
    
            // Display all product images in Bootstrap Carousel
            const imageContainer = document.getElementById("productImageContainer");
            if (product.image_urls.length > 0) {
                imageContainer.innerHTML = createImageCarousel(product.image_urls);
            } else {
                imageContainer.innerHTML = `<img src="/static/default-product.jpg" class="img-fluid rounded shadow" alt="Product Image">`;
            }
    
            // Update chat link
            document.getElementById("chatSeller").dataset.receiverId = product.id;
            
            loadEntityInfo(product.owner_id)

        } catch (error) {
            console.error("Error loading product:", error);
            alert("Failed to load product details.");
        }
    }
    
    // Function to Create Bootstrap Carousel for Images
    function createImageCarousel(images) {
        let indicators = "";
        let slides = "";
    
        images.forEach((imgUrl, index) => {
            const activeClass = index === 0 ? "active" : "";
            indicators += `<button type="button" data-bs-target="#productCarousel" data-bs-slide-to="${index}" class="${activeClass}" aria-label="Slide ${index + 1}"></button>`;
            slides += `
                <div class="carousel-item ${activeClass}">
                    <img src="/${imgUrl}" class="d-block w-100 rounded" alt="Product Image">
                </div>`;
        });
    
            return `
                <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-indicators">${indicators}</div>
                    <div class="carousel-inner">${slides}</div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>`;
        }
    
    // Load product details when page loads
    document.addEventListener("DOMContentLoaded", loadProductDetails);
    
    async function loadEntityInfo(user_id) {
    
        let response = await fetch(`/api/ent/${user_id}`, {
            method: "GET",
             }
        );
    
        if (response.ok) {
            let entity = await response.json();

            document.getElementById("entityName").innerHTML =    `–ü—Ä–æ–¥–∞–≤–µ—Ü: ${entity.entity_name}`;
            document.getElementById("entityPhone").innerHTML =   `–¢–µ–ª.    : ${entity.entity_phone}`;
            document.getElementById("entityAddress").innerHTML = `–ê–¥—Ä–µ—Å   : ${entity.entity_address}`;
            document.getElementById("entityWhatsApp").innerHTML = `–í–æ—Å—Ç–∞–ø : ${entity.entity_whatsapp}`;
        } else {
            let errorData = await response.json();
            console.log("Error Response:", errorData);
            document.getElementById("userInfo").innerText = "Error loading user data.";
        }
    }


</script>

<script src="{{ url_for('static', path='utils.js') }}"></script>

{% endblock %}