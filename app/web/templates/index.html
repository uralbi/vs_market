{% extends "base.html" %}

{% block content %}

<div class="pagetitle">
    <h1>Поиск объявлений</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Главная</a></li>
        <li class="breadcrumb-item">Поиск</li>
      </ol>
    </nav>
  </div>


{% include "product_forms/search_form.html" %}


<h1> Новые объявления</h1>

<div id="productContainer" class="clearfix">
</div>


<script>
async function fetchProducts() {
    try {
        let response = await fetch("/api/products/list");  // Fetch from API
        let products = await response.json();

        let productContainer = document.getElementById("productContainer");
        productContainer.innerHTML = "";  // Clear loading text

        if (products.length === 0) {
            productContainer.innerHTML = "<p>No products found.</p>";
            return;
        }
        let timer = 0;
        products.forEach(product => {
            let productCard = createProductCard(product, timer);
            timer += 10;
            productContainer.appendChild(productCard);
        });

        // AOS.refresh();
        
        if (typeof AOS !== "undefined") {
            AOS.refresh();
        } else {
            console.warn("AOS is not defined. Retrying...");
            setTimeout(() => {
                if (typeof AOS !== "undefined") {
                    AOS.refresh();
                } else {
                    console.error("AOS is still not defined.");
                }
            }, 500);  // Wait and retry after 500ms
        }
        
    } catch (error) {
        console.error("Error fetching products:", error);
        document.getElementById("productContainer").innerHTML = "<p>Error loading products.</p>";
    }
}

fetchProducts();

let user_favs = {{ current_user.favorite_products | get_ids | tojson | safe }};

if (user_favs.includes(58)) {
    console.log('58 in user favs', user_favs)
}

function createImageCarousel(productId, imageUrls) {
    let indicators = "";
    let slides = "";

    imageUrls.forEach((imgUrl, index) => {
        const activeClass = index === 0 ? "active" : "";
        indicators += `
            <button type="button" data-bs-target="#carousel_${productId}" data-bs-slide-to="${index}" class="${activeClass}" aria-label="Slide ${index + 1}"></button>
        `;
        slides += `
            <div class="carousel-item ${activeClass}">
                <img src="/${imgUrl}" class="d-block w-100 rounded" alt="Product Image">
            </div>
        `;
    });

    return `
        <div id="carousel_${productId}" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-indicators">${indicators}</div>
            <div class="carousel-inner">${slides}</div>
            <button class="carousel-control-prev" type="button" data-bs-target="#carousel_${productId}" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#carousel_${productId}" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
            </button>
        </div>
    `;
}

function createProductCard(product, delay) {
    let productCard = document.createElement("div");
    productCard.classList.add("product-card", "card");
    productCard.setAttribute("data-aos", "fade-in");
    productCard.setAttribute("data-aos-delay", delay);
    let imageUrls = product.image_urls && product.image_urls.length > 0 ? product.image_urls : ["/static/no-image.png"];
    //let productName = `${product.name} <span class="card-text"> - ${product.description} </span>`;
    let productName = product.name;
    let maxLength = 18;
    let truncatedName = product.name.length > maxLength 
    ? productName.substring(0, maxLength) 
    : productName;
    
    productCard.innerHTML = `
        <div class="card-img-top">
            ${createImageCarousel(product.id, imageUrls)}
        </div>
        <div class="card-body">
            <a href="/product/${product.id}"><h5 class="card-title">${truncatedName}</h5></a>

        {% if current_user %}
            <button class="chat_btn btn btn-outline-secondary btn-sm" 
                data-aos-delay="10"
                onclick="openChat(${product.owner_id}, ${product.id})">
                <i class="bi bi-chat-left-text"></i>
            </button>

            <button class="btn btn-sm btn-outline-secondary pin_btn"
                id="pin_${product.id}" 
                onclick="addToFavorites(${product.id})">
                <i class="bi bi-paperclip"></i>
            </button>
            {% else %}

            <button class="chat_btn btn btn-outline-secondary btn-sm" 
                data-aos-delay="10" disabled>
                <i class="bi bi-chat-left-text"></i>
            </button>

            <button class="btn btn-sm btn-outline-secondary pin_btn"
                id="pin_${product.id}" disabled>
                <i class="bi bi-paperclip"></i>
            </button>


        {% endif %}
            <p class="card-price">
                ${displayPrice(product.price, product.is_dollar)}
            </p>
        </div>
    `;

    return productCard;
}

</script>

{% endblock %}
