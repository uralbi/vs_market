{% extends "base.html" %}

{% block content %}

{% include "product_forms/search_form.html" %}


<div id="SearchContainer" class="clearfix"></div>

<h4> Новые объявления </h4>

<div id="productContainer" class="clearfix">
</div>


<script>
async function fetchProducts() {
    try {
        let response = await fetch("/api/products/list");  // Fetch from API
        let products = await response.json();

        let productContainer = document.getElementById("productContainer");
        productContainer.innerHTML = "";  // Clear loading text

        if (products.length === 0) {
            productContainer.innerHTML = "<p>No products found.</p>";
            return;
        }

        products.forEach(product => {
            let productCard = document.createElement("div");
            productCard.classList.add("product-card");
            productCard.classList.add("card");            
            let imageUrl = ''
            if (product.image_urls) {
                imageUrl = product.image_urls.length > 0 ? product.image_urls[0] : "/static/no-image.png";
            } else {
                imageUrl = "static/no-image.png";
            }
            
            productCard.innerHTML = `
                <img src="/${product.image_urls[0]}" alt="Product Image" class="card-img-top">
                <div class="card-body">
                    <h5 class="card-title">${product.name}</h5>
                    <p class="card-text">${product.description}</p>
                    <p class="">Price: $${product.price.toFixed(2)}</p>
                    <p>Category: ${product.category}</p>
                    <button class="btn btn-sm btn-outline-success pin_btn" id="pin_${product.id}" 
                        onclick="addToFavorites(${product.id})">
                        &#128206;
                    </button>
                </div>
                `;

            productContainer.appendChild(productCard);
        });

    } catch (error) {
        console.error("Error fetching products:", error);
        document.getElementById("productContainer").innerHTML = "<p>Error loading products.</p>";
    }
}

// Load products when the page loads
fetchProducts();

async function addToFavorites(productId) {
    
    let tokenRow = document.cookie.split('; ').find(row => row.startsWith('access_token='));

    if (!tokenRow) {
        console.warn("User is not authenticated.");
        return;  // Stop execution if no token is found
    }

    let token = tokenRow.split("=")[1]

    let response = await fetch(`/favs/${productId}`, {
        method: "POST",
        headers: { "Authorization": `Bearer ${token}` }
    });

    if (response.ok) {

        let button = document.getElementById(`pin_${productId}`)
        button.classList.remove("btn-outline-success");
        button.classList.add("btn-primary");
    } else {
        let error = await response.json();
        alert(error.detail);
    }
}

async function removeFromFavorites(productId) {


    let tokenRow = document.cookie.split('; ').find(row => row.startsWith('access_token='));

    if (!tokenRow) {
        console.warn("User is not authenticated.");
        return;  // Stop execution if no token is found
    }

    let token = tokenRow.split("=")[1];  // Extract token value

    let response = await fetch(`/favs/${productId}`, {
        method: "DELETE",
        headers: { "Authorization": `Bearer ${token}` }
    });

    if (response.ok) {
        console.log('Unpinned')
    } else {
        let error = await response.json();
        alert(error.detail);
    }
}

</script>

<script>

        // ✅ Connect to the SSE endpoint
    const eventSource = new EventSource("/api/products/sse_products");

    eventSource.onmessage = function(event) {
        let product = JSON.parse(event.data);

        // ✅ Add new product to the list dynamically
        let productList = document.getElementById("productContainer");
        let productCard = document.createElement("div");
        productCard.classList.add("product-card");
        productCard.classList.add("card");
        productCard.innerHTML = `
            <img src="/${product.image_urls[0]}" alt="Product Image" class="card-img-top">
            <div class="card-body">
                <h5 class="card-title">${product.name}</h3>
                <p class="card-text">${product.description}</p>
                <p class="">Price: $${product.price.toFixed(2)}</p>
                <p>Category: ${product.category}</p>
            </div>
        `;
        
        productList.prepend(productCard);  // Insert new product at the top
    };

    eventSource.onerror = function(error) {
        console.error("SSE Error:", error);
    };

</script>

{% endblock %}
