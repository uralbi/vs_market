{% extends "base.html" %}

{% block content %}

<div class="container">

<h1> –ú–æ—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ </h1>

<hr>
<h2>Entity Details</h2>
<p><strong>Entity Name:</strong> <span id="entityName">Loading...</span></p>
<p><strong>Phone:</strong> <span id="entityPhone">Loading...</span></p>
<p><strong>Address:</strong> <span id="entityAddress">Loading...</span></p>
<p><strong>WhatsApp:</strong> <span id="entityWhatsApp">Loading...</span></p>

<button id="deleteEntityBtn" class="btn btn-sm btn-outline-danger" >Delete Entity</button>

<hr>

<h5>Chat Rooms:</h5>
        <ul class="list-group" id="chatRoomsList"></ul>
<hr>

{% include "product_forms/mylist.html" %}


<hr>

{% include "product_forms/myfavs.html" %}

<hr>

{% include "entity_forms/create_entity.html" %}

<hr>



{% include "entity_forms/update_entity.html" %}

<hr>

{% include "entity_forms/change_pass.html" %}

<hr>

{% include "entity_forms/update_email.html" %}


<script>
    let EntityID;

    async function loadUserInfo(user_id) {
        try {
            let response = await fetch(`/api/ent/${user_id}`, { method: "GET" });
    
            if (!response.ok) {
                let errorData = await response.json();
                console.log("No entity for this user");
                return;
            } else {

            let entity = await response.json();
    
            document.getElementById("entityName").innerText = entity.entity_name;
            document.getElementById("entityPhone").innerText = entity.entity_phone;
            document.getElementById("entityAddress").innerText = entity.entity_address;
            document.getElementById("entityWhatsApp").innerText = entity.entity_whatsapp;
    
            EntityID = entity.id;
            }
    
        } catch (error) {
            console.error("Fetch error:", error);
            document.getElementById("userInfo").innerText = "Network error.";
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        loadUserInfo({{ current_user.id }});
    });
    

    document.addEventListener("DOMContentLoaded", async function() {
        let token = getAccessTokenFromCookie()
        loadChatRooms(token)
    });

    document.addEventListener("DOMContentLoaded", function() {
        const deleteBtn = document.getElementById("deleteEntityBtn");
        if (deleteBtn && !deleteBtn.hasAttribute("listener")) { // ‚úÖ Prevent duplicate listeners
            deleteBtn.setAttribute("listener", "true"); // ‚úÖ Mark as already added
            deleteBtn.addEventListener("click", async function(event) {
                event.preventDefault();
                const confirmed = confirm("Are you sure you want to delete your entity?");
                if (!confirmed) return;
    
                try {
                    let token = getAccessTokenFromCookie();
                    const response = await fetch(`/api/ent/${EntitydID}`, {  // ‚úÖ Use corrected `EntitydID`
                        method: "DELETE",
                        headers: {
                            "Authorization": `Bearer ${token}`,
                            "Content-Type": "application/json"
                        }
                    });
    
                    if (response.ok) {
                        alert("Entity deleted successfully!");
                        window.location.reload();
                    } else {
                        const errorData = await response.json();
                        alert(`Failed to delete: ${errorData.detail}`);
                    }
                } catch (error) {
                    console.error("Delete error:", error);
                    alert("Error deleting entity. Please try again.");
                }
            });
        }
    });
    
        

    async function loadChatRooms(token) {
        try {
            const response = await fetch(`/chat/rooms/`, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                }
            });
    
            if (!response.ok) {
                throw new Error("Failed to fetch chat rooms");
            }
    
            const chatRooms = await response.json();
            const chatRoomsList = document.getElementById("chatRoomsList");
    
            // Clear previous chat list to prevent duplication
            chatRoomsList.innerHTML = "";
    
            if (chatRooms.length === 0) {
                chatRoomsList.innerHTML = "<li class='list-group-item'>No chat rooms found</li>";
                return;
            }
    
            chatRooms.forEach(room => {
                const listItem = document.createElement("li");
                listItem.classList.add("list-group-item");
                listItem.innerHTML = `
                    <a href="/messages?user_id={{ current_user.id }}&receiver_id=${room.other_user_id}" 
                    class="text-decoration-none">
                        Chat with ${room.other_username} &#128172; 
                    </a>
                    <button class="btn btn-danger btn-sm" onclick="deleteChatRoom(${room.chat_room_id})">
                        üóëÔ∏è 
                </button>
                `;

                chatRoomsList.appendChild(listItem);
            });
        } catch (error) {
            console.error("Error loading chat rooms:", error);
        }
    }
    
    async function deleteChatRoom(chatRoomId) {
        if (!confirm("Are you sure you want to delete this chat room?")) return;
        let token = getAccessTokenFromCookie();
        try {
            const response = await fetch(`/chat/rooms/${chatRoomId}`, {
                method: "DELETE",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                }
            });
    
            if (!response.ok) {
                throw new Error(`Error: ${response.status}`);
            }
    
            alert("Chat room deleted successfully!");
            loadChatRooms(); // Reload chat rooms after deletion
        } catch (error) {
            console.error("Failed to delete chat room:", error);
            alert("Error deleting chat room. Please try again.");
        }
    }

</script>

<br>
<button class="btn btn-sm btn-outline-danger" id="deactivateButton">–£–¥–∞–ª–∏—Ç—å –ê–∫–∫–∞—É–Ω—Ç</button>

<script>
    document.getElementById("deactivateButton").addEventListener("click", async function() {
        if (!confirm("Are you sure you want to deactivate your account? This action is irreversible.")) {
            return;
        }

        let token = getAccessTokenFromCookie();
        if (!token) {
            alert("You are not logged in!");
            return;
        }
        token = token.split("=")[1];

        let response = await fetch("/api/auth/deactivate", {
            method: "POST",
            headers: { "Authorization": `Bearer ${token}` }
        });

        if (response.ok) {
            alert("Your account has been deactivated and will be deleted in 30 days.");
            document.cookie = "access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            window.location.href = "/login"; // Redirect to login or homepage
        } else {
            let error = await response.json();
            alert("Error: " + error.detail);
        }
    });
</script>

</div>
{% endblock %}