{% extends "base.html" %}

{% block content %}

<div class="container">

<h1> Моя страница </h1>

<hr>
<h2>Entity Details</h2>
<p><strong>Entity Name:</strong> <span id="entityName">Loading...</span></p>
<p><strong>Phone:</strong> <span id="entityPhone">Loading...</span></p>
<p><strong>Address:</strong> <span id="entityAddress">Loading...</span></p>
<p><strong>WhatsApp:</strong> <span id="entityWhatsApp">Loading...</span></p>

<button id="deleteEntityBtn" class="btn btn-sm btn-outline-danger" >Delete Entity</button>

<hr>

<h5>Chat Rooms:</h5>
        <ul class="list-group" id="chatRoomsList"></ul>
<hr>

{% include "product_forms/mylist.html" %}


<hr>

{% include "product_forms/myfavs.html" %}

<hr>

{% include "entity_forms/create_entity.html" %}

<hr>



{% include "entity_forms/update_entity.html" %}

<hr>

{% include "entity_forms/change_pass.html" %}

<hr>

{% include "entity_forms/update_email.html" %}


<script>

    async function loadUserInfo() {
        
        let token = getAccessTokenFromCookie()
    
        let response = await fetch("/api/ent/me", {
            method: "GET",
            headers: { "Authorization": `Bearer ${token}` }
        });
    
        if (response.ok) {
            let entity = await response.json();

            document.getElementById("entityName").innerText = entity.entity_name;
            document.getElementById("entityPhone").innerText = entity.entity_phone;
            document.getElementById("entityAddress").innerText = entity.entity_address;
            document.getElementById("entityWhatsApp").innerText = entity.entity_whatsapp;
        } else {
            let errorData = await response.json();
            console.log("Error Response:", errorData);
            document.getElementById("userInfo").innerText = "Error loading user data.";
        }
    }

    document.addEventListener("DOMContentLoaded", loadUserInfo);

    document.addEventListener("DOMContentLoaded", async function() {
        let token = getAccessTokenFromCookie()

        let response = await fetch("/api/auth/me", {
            method: "GET",
            headers: { "Authorization": `Bearer ${token}` }
        });

        if (response.ok) {
            let user = await response.json();

            // Fetch entity details
            let entityResponse = await fetch("/api/ent/me", {
                method: "GET",
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (entityResponse.ok) {
                load_chats(token)
                let entity = await entityResponse.json();
                document.getElementById("entityName").innerText = entity.entity_name;
                document.getElementById("entityPhone").innerText = entity.entity_phone;
                document.getElementById("entityAddress").innerText = entity.entity_address;
                document.getElementById("entityWhatsApp").innerText = entity.entity_whatsapp;

                // Delete button functionality
                document.getElementById("deleteEntityBtn").addEventListener("click", async function() {
                    if (!confirm("Are you sure you want to delete your entity?")) return;

                    let deleteResponse = await fetch(`/api/ent/${entity.id}`, {
                        method: "DELETE",
                        headers: { "Authorization": `Bearer ${token}` }
                    });

                    if (deleteResponse.ok) {
                        document.getElementById("deleteMessage").innerText = "Entity deleted successfully!";
                    } else {
                        let error = await deleteResponse.json();
                        document.getElementById("deleteMessage").innerText = error.detail || "Failed to delete entity.";
                    }
                });

            } else {
                document.getElementById("deleteMessage").innerText = "No entity found.";
            }
        } else {
            document.getElementById("deleteMessage").innerText = "Error fetching user info.";
        }
    });

    async function load_chats(token) {
        try {
            const response = await fetch(`/chat/rooms/`, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                }
            });
    
            if (!response.ok) {
                throw new Error("Failed to fetch chat rooms");
            }
    
            const chatRooms = await response.json();
            const chatRoomsList = document.getElementById("chatRoomsList");
    
            // Clear previous chat list to prevent duplication
            chatRoomsList.innerHTML = "";
    
            if (chatRooms.length === 0) {
                chatRoomsList.innerHTML = "<li class='list-group-item'>No chat rooms found</li>";
                return;
            }
    
            chatRooms.forEach(room => {
                const listItem = document.createElement("li");
                listItem.classList.add("list-group-item");
    
                listItem.innerHTML = `
                    <a href="/messages?chat_room_id=${room.chat_room_id}&receiver_id=${room.other_user_id}" 
                    class="text-decoration-none">
                        Chat with User ${room.other_user_id}
                    </a>
                `;

                chatRoomsList.appendChild(listItem);
            });
        } catch (error) {
            console.error("Error loading chat rooms:", error);
            alert("Error loading chat rooms. Please try again.");
        }
    }
    
</script>

<br>
<button class="btn btn-sm btn-outline-danger" id="deactivateButton">Удалить Аккаунт</button>

<script>
    document.getElementById("deactivateButton").addEventListener("click", async function() {
        if (!confirm("Are you sure you want to deactivate your account? This action is irreversible.")) {
            return;
        }

        let token = document.cookie.split('; ').find(row => row.startsWith('access_token='));
        if (!token) {
            alert("You are not logged in!");
            return;
        }
        token = token.split("=")[1];

        let response = await fetch("/api/auth/deactivate", {
            method: "POST",
            headers: { "Authorization": `Bearer ${token}` }
        });

        if (response.ok) {
            alert("Your account has been deactivated and will be deleted in 30 days.");
            document.cookie = "access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            window.location.href = "/login"; // Redirect to login or homepage
        } else {
            let error = await response.json();
            alert("Error: " + error.detail);
        }
    });
</script>

</div>
{% endblock %}