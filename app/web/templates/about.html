{% extends "base.html" %}

{% block content %}

<div class="container">

<h1> Моя страница </h1>

<hr>
<h2>Entity Details</h2>
<p><strong>Entity Name:</strong> <span id="entityName">Loading...</span></p>
<p><strong>Phone:</strong> <span id="entityPhone">Loading...</span></p>
<p><strong>Address:</strong> <span id="entityAddress">Loading...</span></p>
<p><strong>WhatsApp:</strong> <span id="entityWhatsApp">Loading...</span></p>

<button id="deleteEntityBtn" class="btn btn-sm btn-outline-danger" >Delete Entity</button>

<hr>

{% include "product_forms/mylist.html" %}


<hr>

{% include "product_forms/myfavs.html" %}

<hr>

{% include "entity_forms/create_entity.html" %}

<hr>



{% include "entity_forms/update_entity.html" %}

<hr>

{% include "entity_forms/change_pass.html" %}

<hr>

{% include "entity_forms/update_email.html" %}


<script>
    async function loadUserInfo() {
        let token = document.cookie.split('; ').find(row => row.startsWith('access_token='));
    
        if (!token) {
            document.getElementById("userInfo").innerText = "You are not logged in.";
            return;
        }
    
        token = token.split('=')[1].trim(); 
    
        let response = await fetch("/api/ent/me", {
            method: "GET",
            headers: { "Authorization": `Bearer ${token}` }
        });
    
        if (response.ok) {
            let entity = await response.json();

            document.getElementById("entityName").innerText = entity.entity_name;
            document.getElementById("entityPhone").innerText = entity.entity_phone;
            document.getElementById("entityAddress").innerText = entity.entity_address;
            document.getElementById("entityWhatsApp").innerText = entity.entity_whatsapp;
        } else {
            let errorData = await response.json();
            console.log("Error Response:", errorData);
            document.getElementById("userInfo").innerText = "Error loading user data.";
        }
    }

    document.addEventListener("DOMContentLoaded", loadUserInfo);
    </script>

<script>
    document.addEventListener("DOMContentLoaded", async function() {
        let token = document.cookie.split('; ').find(row => row.startsWith('access_token='));
        if (token) {
            token = token.split('=')[1]; // Extract the token value
        } else {
            document.getElementById("deleteMessage").innerText = "You must be logged in.";
            return;
        }

        let response = await fetch("/api/auth/me", {
            method: "GET",
            headers: { "Authorization": `Bearer ${token}` }
        });

        if (response.ok) {
            let user = await response.json();

            // Fetch entity details
            let entityResponse = await fetch("/api/ent/me", {
                method: "GET",
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (entityResponse.ok) {
                let entity = await entityResponse.json();
                document.getElementById("entityName").innerText = entity.entity_name;
                document.getElementById("entityPhone").innerText = entity.entity_phone;
                document.getElementById("entityAddress").innerText = entity.entity_address;
                document.getElementById("entityWhatsApp").innerText = entity.entity_whatsapp;

                // Delete button functionality
                document.getElementById("deleteEntityBtn").addEventListener("click", async function() {
                    if (!confirm("Are you sure you want to delete your entity?")) return;

                    let deleteResponse = await fetch(`/api/ent/${entity.id}`, {
                        method: "DELETE",
                        headers: { "Authorization": `Bearer ${token}` }
                    });

                    if (deleteResponse.ok) {
                        document.getElementById("deleteMessage").innerText = "Entity deleted successfully!";
                    } else {
                        let error = await deleteResponse.json();
                        document.getElementById("deleteMessage").innerText = error.detail || "Failed to delete entity.";
                    }
                });

            } else {
                document.getElementById("deleteMessage").innerText = "No entity found.";
            }
        } else {
            document.getElementById("deleteMessage").innerText = "Error fetching user info.";
        }
    });
</script>

<br>
<button class="btn btn-sm btn-outline-danger" id="deactivateButton">Удалить Аккаунт</button>

<script>
    document.getElementById("deactivateButton").addEventListener("click", async function() {
        if (!confirm("Are you sure you want to deactivate your account? This action is irreversible.")) {
            return;
        }

        let token = document.cookie.split('; ').find(row => row.startsWith('access_token='));
        if (!token) {
            alert("You are not logged in!");
            return;
        }
        token = token.split("=")[1];

        let response = await fetch("/api/auth/deactivate", {
            method: "POST",
            headers: { "Authorization": `Bearer ${token}` }
        });

        if (response.ok) {
            alert("Your account has been deactivated and will be deleted in 30 days.");
            document.cookie = "access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            window.location.href = "/login"; // Redirect to login or homepage
        } else {
            let error = await response.json();
            alert("Error: " + error.detail);
        }
    });
</script>

</div>
{% endblock %}