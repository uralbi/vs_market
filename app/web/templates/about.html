{% extends "base.html" %}

{% block content %}

<div class="container">

<h1> Добро пожаловать {{current_user.username}} !</h1>

    <div class="card shadow-sm border-0 rounded-3 w-50 mb-4">
        <div class="profile_note"></div>
        <div class="card-body p-2 profile_card">
            <hr>
            <h5 class="mb-1 text-secondary my_profile_title">Мой профиль</h5>
            <div class="profile_card_body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center p-1">
                        <span class="fw-semibold">Название:</span>
                        <span id="entityName" class="text-muted">Loading...</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center p-1">
                        <span class="fw-semibold">Телефон:</span>
                        <span id="entityPhone" class="text-muted">Loading...</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center p-1">
                        <span class="fw-semibold">Адрес:</span>
                        <span id="entityAddress" class="text-muted">Loading...</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center p-1">
                        <span class="fw-semibold">Востап:</span>
                        <span id="entityWhatsApp" class="text-muted">Loading...</span>
                    </li>
                </ul>

                <button id="deleteEntityBtn" class="btn btn-sm btn-outline-danger" >Удалить Профиль</button>
            
            </div>
        </div>
    </div>

<hr>

<h5>Chat Rooms:</h5>
        <ul class="list-group" id="chatRoomsList"></ul>
<hr>


{% include "product_forms/mylist.html" %}

<hr>

{% include "product_forms/myfavs.html" %}

<hr>

{% include "entity_forms/create_entity.html" %}

<hr>



{% include "entity_forms/update_entity.html" %}

<hr>

{% include "entity_forms/change_pass.html" %}

<hr>

{% include "entity_forms/update_email.html" %}


<script>
    let EntityID;

    async function loadUserInfo(user_id) {
        try {
            let response = await fetch(`/api/ent/${user_id}`, { method: "GET" });
    
            if (!response.ok) {
                let errorData = await response.json();
                console.log("No entity for this user");
                document.getElementsByClassName("profile_card_body")[0].style.display = "none";
                document.getElementsByClassName("my_profile_title")[0].innerText = "Профиль не создан.";
                profile_card

                return;
            } else {

            let entity = await response.json();
    
            document.getElementById("entityName").innerText = entity.entity_name;
            document.getElementById("entityPhone").innerText = entity.entity_phone;
            document.getElementById("entityAddress").innerText = entity.entity_address;
            document.getElementById("entityWhatsApp").innerText = entity.entity_whatsapp;
    
            EntityID = entity.id;
            }
    
        } catch (error) {
            console.error("Fetch error:", error);
            document.getElementById("userInfo").innerText = "Network error.";
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        loadUserInfo({{ current_user.id }});
    });
    

    document.addEventListener("DOMContentLoaded", async function() {
        let token = getAccessTokenFromCookie()
        loadChatRooms(token)
    });

    document.addEventListener("DOMContentLoaded", function() {
        const deleteBtn = document.getElementById("deleteEntityBtn");
        if (deleteBtn && !deleteBtn.hasAttribute("listener")) { // Prevent duplicate listeners
            deleteBtn.setAttribute("listener", "true"); // Mark as already added
            deleteBtn.addEventListener("click", async function(event) {
                event.preventDefault();
                const confirmed = confirm("Подтвердите удаление.");
                if (!confirmed) return;
    
                try {
                    let token = getAccessTokenFromCookie();
                    const response = await fetch(`/api/ent/${EntityID}`, {  // ✅ Use corrected `EntitydID`
                        method: "DELETE",
                        headers: {
                            "Authorization": `Bearer ${token}`,
                            "Content-Type": "application/json"
                        }
                    });
    
                    if (response.ok) {
                        alert("Entity deleted successfully!");
                        window.location.reload();
                    } else {
                        const errorData = await response.json();
                        alert(`Failed to delete: ${errorData.detail}`);
                    }
                } catch (error) {
                    console.error("Delete error:", error);
                    alert("Error deleting entity. Please try again.");
                }
            });
        }
    });
    
        
    async function loadChatRooms(token) {
        try {
            const response = await fetch(`/chat/rooms/`, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                }
            });
    
            if (!response.ok) {
                throw new Error("Failed to fetch chat rooms");
            }
    
            const chatRooms = await response.json();
            const chatRoomsList = document.getElementById("chatRoomsList");
    
            // Clear previous chat list to prevent duplication
            chatRoomsList.innerHTML = "";
    
            if (chatRooms.length === 0) {
                chatRoomsList.innerHTML = "<li class='list-group-item'>No chat rooms found</li>";
                return;
            }
    
            chatRooms.forEach(room => {
                const listItem = document.createElement("li");
                listItem.classList.add("my_list_group");
                listItem.innerHTML = `
                    <a href="/messages?room_id=${room.chat_room_id}" class="text-decoration-none">
                    
                        Chat with ${room.other_username}  <span class="my_badge_unread"> 
                        ${room.has_unread_messages ? `<i class="bi bi-envelope-arrow-down text-warning"></i>`: `<i class="bi bi-check2-circle text-success"></i>`} </span>
                    </a>
                    <button class="btn btn-outline-danger btn-sm float-end" onclick="deleteChatRoom(${room.chat_room_id})">
                        <i class="bi bi-trash3"></i> 
                </button>
                `;

                chatRoomsList.appendChild(listItem);
            });
        } catch (error) {
            console.error("Error loading chat rooms:", error);
        }
    }
    
    async function deleteChatRoom(chatRoomId) {
        if (!confirm("Are you sure you want to delete this chat room?")) return;
        let token = getAccessTokenFromCookie();
        try {
            const response = await fetch(`/chat/rooms/${chatRoomId}`, {
                method: "DELETE",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                }
            });
    
            if (!response.ok) {
                throw new Error(`Error: ${response.status}`);
            }
    
            alert("Chat room deleted successfully!");
            loadChatRooms(); // Reload chat rooms after deletion
        } catch (error) {
            console.error("Failed to delete chat room:", error);
            alert("Error deleting chat room. Please try again.");
        }
    }

</script>

<br>
<button class="btn btn-sm btn-outline-danger" id="deactivateButton">Удалить Аккаунт</button>

<script>
    document.getElementById("deactivateButton").addEventListener("click", async function() {
        if (!confirm("Удалить Аккаунт?.")) {
            return;
        }

        let token = getAccessTokenFromCookie();
        if (!token) {
            alert("Вы не вошли в систему!");
            return;
        }
        token = token.split("=")[1];

        let response = await fetch("/api/auth/deactivate", {
            method: "POST",
            headers: { "Authorization": `Bearer ${token}` }
        });

        if (response.ok) {
            alert("Your account has been deactivated and will be deleted in 30 days.");
            document.cookie = "access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            window.location.href = "/login"; // Redirect to login or homepage
        } else {
            let error = await response.json();
            alert("Error: " + error.detail);
        }
    });
</script>

</div>
{% endblock %}